name: Integration tests
on:
  workflow_call:
    inputs:
      cnspecImageTag:
        required: true
        type: string
    secrets:
      MONDOO_CLIENT:
        required: true
      MONDOO_CLIENT_EDGE:
        required: true

env:
  CNSPEC_IMAGE_TAG: ${{ github.event.inputs.cnspecImageTag }}

# https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
permissions:
  contents: read
# Attention: These jobs still have access to all the secrets.

jobs:
  build-operator:
    runs-on: ubuntu-latest
    name: Build operator container
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false
          fetch-depth: 0 # fetch is needed for "git tag --list" in the Makefile
      - name: Import environment variables from file
        run: cat ".github/env" >> $GITHUB_ENV
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: "${{ env.golang-version }}"
      - name: Build operator container image
        run: make docker-save
      - name: Generate manifests
        run: make manifests generate generate-manifests
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: operator-build
          path: |
            operator.tar
            mondoo-operator-manifests.yaml
          retention-days: 1

  integration-tests:
    runs-on: ubuntu-latest
    name: Integration tests
    needs: [build-operator]
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.32.0, v1.35.0]
        k8s-distro: [minikube, k3d]

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false
          fetch-depth: 0 # fetch is needed for "git tag --list" in the Makefile
      - name: Import environment variables from file
        run: cat ".github/env" >> $GITHUB_ENV

      - name: Start minikube
        uses: medyagh/setup-minikube@master
        if: matrix.k8s-distro == 'minikube'
        with:
          memory: 4000m
          kubernetes-version: ${{ matrix.k8s-version }}

      - name: Start k3d
        uses: nolar/setup-k3d-k3s@293b8e5822a20bc0d5bcdd4826f1a665e72aba96 # v1.0.9
        if: matrix.k8s-distro == 'k3d'
        with:
          version: ${{ matrix.k8s-version }}
          k3d-args: --k3s-arg=--disable=traefik@server:*

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: "${{ env.golang-version }}"

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        name: Download operator build artifact
        with:
          name: operator-build

      # Makes it easier to see what was the input for this workflow in case we need to debug.
      - name: Print workflow inputs
        run: echo "${{ toJSON(github.event.inputs) }}"

      - run: sleep 10

      # Now that dependencies are cached the tests start almost immediately after minikube has started
      # this makes tests fail occasionally. This sleep gives the runner some time to become more stable
      # before the test execution starts.
      - name: Wait a bit for the runner to become more stable
        run: for i in 1 2 3 4 5; do kubectl -n kube-system wait --for=condition=Ready pods --all --timeout=180s && break || sleep 10; done

      - name: Run integration tests
        env:
          MONDOO_API_TOKEN: ${{ secrets.MONDOO_TEST_ORG_TOKEN }}
        run: K8S_DISTRO=${{ matrix.k8s-distro }} make test/integration/ci

      - run: mv integration-tests.xml integration-tests-${{ matrix.k8s-distro }}-${{ matrix.k8s-version }}.xml
        if: success() || failure()

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: success() || failure() # run this step even if previous step failed
        with: # upload a combined archive with unit and integration test results
          name: test-results-${{ matrix.k8s-distro }}-${{ matrix.k8s-version }}
          path: integration-tests-${{ matrix.k8s-distro }}-${{ matrix.k8s-version }}.xml

      - name: Upload test logs artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: failure()
        with:
          name: test-logs-${{ matrix.k8s-distro }}-${{ matrix.k8s-version }}
          path: /home/runner/work/mondoo-operator/mondoo-operator/tests/integration/_output/

  slack-notification:
    runs-on: ubuntu-latest
    name: Send Slack notification
    needs: [integration-tests]
    # Run only if the previous job has failed and only if it's running against the main branch
    if: ${{ always() && contains(join(needs.*.result, ','), 'fail') && github.ref_name == 'main' }}
    steps:
      - name: Send Slack notification on failure
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        if: ${{ always() && steps.build-providers.outcome != 'success' }}
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "C07QZDJFF89",
              "text": "⚠️ Mondoo-operator integration tests failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":x: *Mondoo-operator integration tests failed*:  <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View GitHub Action Run>"
                  }
                }
              ]
            }
